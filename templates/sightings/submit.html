{% extends "core/jqm-page.html" %}

{% block extra_head %}
<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=true"></script>
<style type="text/css">
    .map { width:100%; height: 300px; }
    input:invalid { color: red; }
    .errors { color: red; }
</style>
{% endblock extra_head %}

{% block title %}Submit a Sighting{% endblock %}
{% block class %}submit-sighting-page{% endblock %}
{% block id %}submit-sighting-page{% endblock %}

{% block page %}
            
    <div data-role="content" class="at-content" role="main">
        <form class="form submit-sighting-form ui-shadow" action="" method="post" data-ajax="false" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-intro">
                <p>Intro blurb goes here lorem ipsum dolor sit amet,
                consectetur adipiscing elit. Maecenas cursus aliquam eros
                luctus posuere. Cras tincidunt, eros ac sagittis dapibus.</p>
            </div>
            {% if not request.user.is_authenticated %}
            <div class="form-row">
                <label for="email" class="ui-input-text">Email Address</label>
                <input class="email" type="email"
                    name="creator_email" id="id_creator_email"
                    value="{{ form.creator_email.value }}" placeholder="Enter your email"
                    required aria-required="true" />
            </div><!--//form-row-->
            {% endif %}
            <div class="form-row{% if form.errors.tag_number %} errors{% endif %}">
                {{ form.errors.tag_number }}
                <label for="id_tag_number">Tag Number (if present)</label>
                <input class="tag-number" type="text" name="tag_number"
                pattern="[\d]+"
                id="id_tag_number" placeholder="eg. 12344" value="{{ form.tag_number.value }}" />
            </div><!--//form-row-->
            <div class="form-row{% if form.errors.image %} errors{% endif %}">
                {{ form.errors.image }}
                <label for="id_image">Select a photo</label>
                <input id="id_image" type="file" name="image" single 
                    required aria-required="true" />
            </div><!--//form-row-->
            
            <div class="form-row{% if form.errors.location %} errors{% endif %}">
                {{ form.errors.location }}
                <label for="id_location" class="ui-input-text">Tree location</label>
                <span class="help-text">Drag the pin (or click elsewhere) to move the location.</span>
                <div id="map_canvas" class="map"></div>
                <input type="text" name="location" id="id_location" value="{{ form.location.value }}" />
            </div>
            
            <div class="form-row{% if form.errors.disease_state %} errors{% endif %}">
            <fieldset data-role="controlgroup">
                {{ form.errors.disease_state }}
                <legend>Does this tree appear to have the Ash Dieback Disease?</legend>
                <input type="radio" name="disease_state"
                id="id_disease_state_1" value=""
                {% if form.disease_state.value == "" or form.disease_state.value == None %}checked="checked"{% endif %} />
                    <label for="id_disease_state_1">I don't know</label>
        
                    <input type="radio" name="disease_state"
                    id="id_disease_state_2" value="True"
                    {% if form.disease_state.value == 'True' %}checked="checked"{% endif %}
                    />
                    <label for="id_disease_state_2">Yes</label>
        
                    <input type="radio" name="disease_state"
                    id="id_disease_state_3" value="False"
                    {% if form.disease_state.value == 'False' %}checked="checked"{% endif %}
                    />
                    <label for="id_disease_state_3">No</label>
            </fieldset>
            </div><!--//form-row-->
            <div class="form-row">
            <label for="id_notes">Leave a comment</label>
            <textarea cols="40" rows="8" name="notes" id="id_notes">{{ form.notes.value }}</textarea>
            </div><!--//form-row-->

            <div class="cta-btn-wrapper">
                <input class="button submit-sighting" type="submit" value="Submit" name="submit-sighting" />
            </div>
        </form><!--//submit-sighting-form-->                          
   
    </div><!--//at-content-->  

<script type="text/javascript">
        var defaultZoom = 5;
        // centroid of UK ish.
        var defaultLat = 54.03;
        var defaultLng = -3.67;

        $(document).bind('pageinit', function() {
            if ($('#id_location').val() !== '') {
                var latLng = parseWKTPoint($('#id_location').val());
                initialize(19, latLng[0], latLng[1]);
            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position){
                            initialize(19, position.coords.latitude, position.coords.longitude);
                        },
                        function() {
                            initialize(defaultZoom, defaultLat, defaultLng);
                        },
                        {timeout:5000});
                } else {
                    initialize(defaultZoom, defaultLat, defaultLng);
                }
            }
        });

        function parseWKTPoint(text) {
            // return lat, lng from WKT POINT
            var re = /^POINT\s*\(([-\.\d]+) ([-\.\d]+)\)$/g;
            var match = re.exec(text);
            return [parseFloat(match[2]), parseFloat(match[1])]
        }

        function updateLocation(latLng, create){
            // set marker and location input
            if (create !== undefined && create) {
                $('#map_canvas').gmap('clear', 'markers');
                $('#map_canvas').gmap('addMarker', {
                    'position': latLng, 
                    'draggable': true, 
                    'bounds': false
                }).dragend(function(event) {
                    updateLocation(event.latLng, false);
                }).click( function() {
                });
            }
            $('#id_location').val(
                "POINT (" + latLng.lng() + " " + latLng.lat() + ")"
            );
        }
        
        function initialize(zoom, lat, lng) {
            // create map and set marker
            var latLng = new google.maps.LatLng(lat, lng);
            var mapOpts = {
                center: latLng,
                zoom: zoom,
                mapTypeId: google.maps.MapTypeId.HYBRID
            };
            $('#map_canvas').gmap(mapOpts).bind('init', function(event, map) {
                updateLocation(latLng, true);
                $(map).click( function(event) {
                    updateLocation(event.latLng, true);
                });
            });
        }
</script>

{% endblock page %}


