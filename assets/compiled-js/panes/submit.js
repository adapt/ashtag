// Generated by CoffeeScript 1.7.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  module('ashtag.panes');

  ashtag.panes.SubmitSightingPane = (function(_super) {
    __extends(SubmitSightingPane, _super);

    function SubmitSightingPane() {
      this.handleSyncProgress = __bind(this.handleSyncProgress, this);
      this.handleSyncEnd = __bind(this.handleSyncEnd, this);
      this.handleSyncStart = __bind(this.handleSyncStart, this);
      this.sync = __bind(this.sync, this);
      this.updateSavedForLater = __bind(this.updateSavedForLater, this);
      this.resetForm = __bind(this.resetForm, this);
      this.hideOfflineStorageMessage = __bind(this.hideOfflineStorageMessage, this);
      this.showOfflineStorageMessage = __bind(this.showOfflineStorageMessage, this);
      this.loadDefaults = __bind(this.loadDefaults, this);
      this.updateSurveyQuestions = __bind(this.updateSurveyQuestions, this);
      this.handleSubmit = __bind(this.handleSubmit, this);
      this.updateLocation = __bind(this.updateLocation, this);
      return SubmitSightingPane.__super__.constructor.apply(this, arguments);
    }

    SubmitSightingPane.prototype.initialise = function() {
      this.$form = this.$('form');
      this.$imageField = this.$('form #id_image');
      this.$submitButton = this.$form.find('.submit-sighting');
      this.$submitDoneMessages = this.$form.find('.submit-done-msgs');
      this.$savedForLater = this.$form.find('.saved-for-later');
      this.$locationInput = this.$form.find('#id_location');
      this.mapPane = new ashtag.panes.SubmitSightingMapPane(this.$el, this.parseLocation());
      this.fileStore = new ashtag.FileStore();
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.setupEvents = function() {
      this.$form.on('submit', this.handleSubmit);
      $(window).on('online', this.sync);
      this.mapPane.observe('locationChange', (function(_this) {
        return function(e, lat, lng) {
          return _this.updateLocation(lat, lng);
        };
      })(this));
      return this.$form.find('input[name="disease_state"]').on('change', this.updateSurveyQuestions);
    };

    SubmitSightingPane.prototype.updateLocation = function(lat, lng) {
      return this.$locationInput.val("POINT (" + lng + " " + lat + ")");
    };

    SubmitSightingPane.prototype.start = function() {
      this.sync();
      this.updateSurveyQuestions();
      this.loadDefaults();
      return ashtag.extra.geoLocate().then(this.updateLocation, (function(_this) {
        return function() {
          if (!ashtag.extra.online()) {
            return alert('Could not get your location. Find an Internet connection and try again');
          }
        };
      })(this));
    };

    SubmitSightingPane.prototype.handleSubmit = function(e) {
      var $invalid;
      $invalid = this.$form.find(":invalid");
      if ($invalid.length) {
        e.preventDefault();
        $invalid.eq(0).focus();
        return;
      }
      if (this.fileStore.enabled) {
        return this.submitViaFileStore(e);
      } else {
        return this.submitTraditional(e);
      }
    };

    SubmitSightingPane.prototype.updateSurveyQuestions = function() {
      if (this.$('#id_disease_state_likely').is(':checked')) {
        this.$('.survey-if-likely').show();
        return this.$('.survey-if-likely input').attr('checked', false).checkboxradio("refresh");
      } else {
        return this.$('.survey-if-likely').hide();
      }
    };

    SubmitSightingPane.prototype.loadDefaults = function() {
      var $tagNumber;
      $tagNumber = this.$form.find('#id_tag_number');
      if (!$tagNumber.val()) {
        $tagNumber.val(ashtag.extra.getQueryParameter('tag_number'));
      }
      if (ashtag.extra.getQueryParameter('survey')) {
        return this.$('#survey-collapsible').trigger('expand');
      }
    };

    SubmitSightingPane.prototype.submitViaFileStore = function(e) {
      var file, hide, meta, storePromise;
      e.preventDefault();
      meta = this.$form.serialize();
      file = this.$imageField.get(0).files[0];
      storePromise = this.fileStore.storeFile(file, meta);
      this.showOfflineStorageMessage();
      hide = ashtag.extra.callAfter(2, this.hideOfflineStorageMessage);
      setTimeout(hide, 4000);
      return storePromise.then((function(_this) {
        return function() {
          hide();
          return _this.resetForm();
        };
      })(this), (function(_this) {
        return function() {
          _this.fileStore.disable();
          return _this.$form.submit();
        };
      })(this));
    };

    SubmitSightingPane.prototype.submitTraditional = function(e) {};

    SubmitSightingPane.prototype.showOfflineStorageMessage = function() {
      this.$submitButton.parent().hide();
      this.$submitDoneMessages.show();
      return this.$savedForLater.hide();
    };

    SubmitSightingPane.prototype.hideOfflineStorageMessage = function() {
      this.$submitDoneMessages.hide();
      this.$submitButton.parent().show();
      this.$savedForLater.show();
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.resetForm = function() {
      var location;
      location = this.$locationInput.val();
      this.$form.get(0).reset();
      return this.$locationInput.val(location);
    };

    SubmitSightingPane.prototype.updateSavedForLater = function() {
      if (!this.fileStore.enabled) {
        return;
      }
      return this.fileStore.totalPendingFiles().then((function(_this) {
        return function(total) {
          _this.$savedForLater.find('.total').text(total);
          return _this.$savedForLater.toggle(!!total);
        };
      })(this));
    };

    SubmitSightingPane.prototype.sync = function() {
      if (ashtag.extra.online() && this.fileStore.enabled) {
        return this.fileStore.totalPendingFiles().then((function(_this) {
          return function(total) {
            if (total) {
              _this.handleSyncStart();
              return _this.fileStore.allToServer().then(_this.handleSyncEnd, _this.handleSyncEnd, _this.handleSyncProgress);
            }
          };
        })(this));
      }
    };

    SubmitSightingPane.prototype.handleSyncStart = function() {
      if (this.syncing) {
        return;
      }
      this.syncing = true;
      $.mobile.loading('show', {
        text: '',
        textVisible: true
      });
      return this.handleSyncProgress();
    };

    SubmitSightingPane.prototype.handleSyncEnd = function() {
      this.syncing = false;
      $.mobile.loading('hide');
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.handleSyncProgress = function() {
      this.updateSavedForLater();
      return this.fileStore.totalPendingFiles().then((function(_this) {
        return function(total) {
          return $('.ui-loader h1').text("Syncing sightings, " + total + " remaining");
        };
      })(this));
    };

    SubmitSightingPane.prototype.parseLocation = function() {
      var match, re, text;
      text = this.$locationInput.val();
      if (!text) {
        return;
      }
      re = /^POINT\s*\(([-\.\d]+) ([-\.\d]+)\)$/g;
      match = re.exec(text);
      return {
        lat: parseFloat(match[2], 10),
        lng: parseFloat(match[1], 10)
      };
    };

    return SubmitSightingPane;

  })(ashtag.lib.panes.BasePane);

  $(window).on('pagechange', (function(_this) {
    return function(event, obj) {
      if (obj.toPage.attr('id') === 'submit-sighting-page') {
        return new ashtag.panes.SubmitSightingPane(obj.toPage);
      }
    };
  })(this));

}).call(this);
