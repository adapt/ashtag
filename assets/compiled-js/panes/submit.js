// Generated by CoffeeScript 1.6.3
(function() {
  var _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    _this = this;

  module('ashtag.panes');

  ashtag.panes.SubmitSightingPane = (function(_super) {
    __extends(SubmitSightingPane, _super);

    function SubmitSightingPane() {
      this.handleSyncProgress = __bind(this.handleSyncProgress, this);
      this.handleSyncEnd = __bind(this.handleSyncEnd, this);
      this.handleSyncStart = __bind(this.handleSyncStart, this);
      this.sync = __bind(this.sync, this);
      this.updateSavedForLater = __bind(this.updateSavedForLater, this);
      this.resetForm = __bind(this.resetForm, this);
      this.hideOfflineStorageMessage = __bind(this.hideOfflineStorageMessage, this);
      this.showOfflineStorageMessage = __bind(this.showOfflineStorageMessage, this);
      this.handleSubmit = __bind(this.handleSubmit, this);
      this.updateLocation = __bind(this.updateLocation, this);
      _ref = SubmitSightingPane.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    SubmitSightingPane.prototype.initialise = function() {
      this.$form = this.$('form');
      this.$imageField = this.$('form #id_image');
      this.$submitButton = this.$form.find('.submit-sighting');
      this.$submitDoneMessages = this.$form.find('.submit-done-msgs');
      this.$savedForLater = this.$form.find('.saved-for-later');
      this.$locationInput = this.$form.find('#id_location');
      this.mapPane = new ashtag.panes.SubmitSightingMapPane(this.$el, this.parseLocation());
      this.fileStore = new ashtag.FileStore();
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.setupEvents = function() {
      var _this = this;
      this.$form.on('submit', this.handleSubmit);
      $(window).on('online', this.sync);
      return this.mapPane.observe('locationChange', function(e, lat, lng) {
        return _this.updateLocation(lat, lng);
      });
    };

    SubmitSightingPane.prototype.updateLocation = function(lat, lng) {
      return this.$locationInput.val("POINT (" + lng + " " + lat + ")");
    };

    SubmitSightingPane.prototype.start = function() {
      var _this = this;
      this.sync();
      return ashtag.extra.geoLocate().then(this.updateLocation, function() {
        if (!ashtag.extra.online()) {
          return alert('Could not get your location. Find an Internet connection and try again');
        }
      });
    };

    SubmitSightingPane.prototype.handleSubmit = function(e) {
      var $invalid;
      $invalid = this.$form.find(":invalid");
      if ($invalid.length) {
        e.preventDefault();
        $invalid.eq(0).focus();
        return;
      }
      if (this.fileStore.enabled) {
        return this.submitViaFileStore(e);
      } else {
        return this.submitTraditional(e);
      }
    };

    SubmitSightingPane.prototype.submitViaFileStore = function(e) {
      var file, hide, meta, storePromise,
        _this = this;
      e.preventDefault();
      meta = this.$form.serialize();
      file = this.$imageField.get(0).files[0];
      storePromise = this.fileStore.storeFile(file, meta);
      this.showOfflineStorageMessage();
      hide = ashtag.extra.callAfter(2, this.hideOfflineStorageMessage);
      setTimeout(hide, 4000);
      return storePromise.then(function() {
        hide();
        return _this.resetForm();
      }, function() {
        _this.fileStore.disable();
        return _this.$form.submit();
      });
    };

    SubmitSightingPane.prototype.submitTraditional = function(e) {};

    SubmitSightingPane.prototype.showOfflineStorageMessage = function() {
      this.$submitButton.parent().hide();
      this.$submitDoneMessages.show();
      return this.$savedForLater.hide();
    };

    SubmitSightingPane.prototype.hideOfflineStorageMessage = function() {
      this.$submitDoneMessages.hide();
      this.$submitButton.parent().show();
      this.$savedForLater.show();
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.resetForm = function() {
      var location;
      location = this.$locationInput.val();
      this.$form.get(0).reset();
      return this.$locationInput.val(location);
    };

    SubmitSightingPane.prototype.updateSavedForLater = function() {
      var _this = this;
      if (!this.fileStore.enabled) {
        return;
      }
      return this.fileStore.totalPendingFiles().then(function(total) {
        _this.$savedForLater.find('.total').text(total);
        return _this.$savedForLater.toggle(!!total);
      });
    };

    SubmitSightingPane.prototype.sync = function() {
      var _this = this;
      if (ashtag.extra.online() && this.fileStore.enabled) {
        return this.fileStore.totalPendingFiles().then(function(total) {
          if (total) {
            _this.handleSyncStart();
            return _this.fileStore.allToServer().then(_this.handleSyncEnd, _this.handleSyncEnd, _this.handleSyncProgress);
          }
        });
      }
    };

    SubmitSightingPane.prototype.handleSyncStart = function() {
      if (this.syncing) {
        return;
      }
      this.syncing = true;
      $.mobile.loading('show', {
        text: '',
        textVisible: true
      });
      return this.handleSyncProgress();
    };

    SubmitSightingPane.prototype.handleSyncEnd = function() {
      this.syncing = false;
      $.mobile.loading('hide');
      return this.updateSavedForLater();
    };

    SubmitSightingPane.prototype.handleSyncProgress = function() {
      var _this = this;
      this.updateSavedForLater();
      return this.fileStore.totalPendingFiles().then(function(total) {
        return $('.ui-loader h1').text("Syncing sightings, " + total + " remaining");
      });
    };

    SubmitSightingPane.prototype.parseLocation = function() {
      var match, re, text;
      text = this.$locationInput.val();
      if (!text) {
        return;
      }
      re = /^POINT\s*\(([-\.\d]+) ([-\.\d]+)\)$/g;
      match = re.exec(text);
      return {
        lat: parseFloat(match[2], 10),
        lng: parseFloat(match[1], 10)
      };
    };

    return SubmitSightingPane;

  })(ashtag.lib.panes.BasePane);

  $(window).on('pagechange', function(event, obj) {
    if (obj.toPage.attr('id') === 'submit-sighting-page') {
      return new ashtag.panes.SubmitSightingPane(obj.toPage);
    }
  });

}).call(this);
