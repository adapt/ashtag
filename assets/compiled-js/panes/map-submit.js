// Generated by CoffeeScript 1.6.3
(function() {
  var _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  module("ashtag.panes");

  ashtag.panes.SubmitSightingMapPane = (function(_super) {
    __extends(SubmitSightingMapPane, _super);

    function SubmitSightingMapPane() {
      this.handleMapLoad = __bind(this.handleMapLoad, this);
      this.handleMapClick = __bind(this.handleMapClick, this);
      this.handleDragEnd = __bind(this.handleDragEnd, this);
      this.createMarker = __bind(this.createMarker, this);
      _ref = SubmitSightingMapPane.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    SubmitSightingMapPane.prototype.initialise = function() {
      var loc;
      SubmitSightingMapPane.__super__.initialise.apply(this, arguments);
      this.$locationInput = $('#id_location');
      loc = this.parseLocation();
      if (loc) {
        this.defaultLat = loc.lat;
        this.defaultLng = loc.lng;
        return this.defaultZoom = 19;
      } else {
        this.doLocateUser = true;
        return this.zoomedInZoomLevel = 19;
      }
    };

    SubmitSightingMapPane.prototype.parseLocation = function() {
      var match, re, text;
      text = this.$locationInput.val();
      if (!text) {
        return;
      }
      re = /^POINT\s*\(([-\.\d]+) ([-\.\d]+)\)$/g;
      match = re.exec(text);
      return {
        lat: parseFloat(match[2], 10),
        lng: parseFloat(match[1], 10)
      };
    };

    SubmitSightingMapPane.prototype.createMarker = function(lat, lng) {
      if (!this.marker) {
        this.marker = new google.maps.Marker({
          position: new google.maps.LatLng(lat, lng),
          draggable: true,
          bounds: false,
          map: this.map
        });
      } else {
        this.marker.setPosition(new google.maps.LatLng(lat, lng));
      }
      google.maps.event.addDomListener(this.marker, 'dragend', this.handleDragEnd);
      return this.updateLocation(lat, lng);
    };

    SubmitSightingMapPane.prototype.handleDragEnd = function(e) {
      return this.updateLocation(e.latLng.lat(), e.latLng.lng());
    };

    SubmitSightingMapPane.prototype.handleMapClick = function(e) {
      this.createMarker(e.latLng.lat(), e.latLng.lng());
      return this.updateLocation(e.latLng.lat(), e.latLng.lng());
    };

    SubmitSightingMapPane.prototype.updateLocation = function(lat, lng) {
      return this.$locationInput.val("POINT (" + lng + " " + lat + ")");
    };

    SubmitSightingMapPane.prototype.handleMapLoad = function() {
      SubmitSightingMapPane.__super__.handleMapLoad.apply(this, arguments);
      google.maps.event.addDomListener(this.map, 'click', this.handleMapClick);
      if (this.doLocateUser) {
        return this.centerOnUser().then(this.createMarker);
      } else {
        return this.createMarker(this.defaultLat, this.defaultLng);
      }
    };

    return SubmitSightingMapPane;

  })(ashtag.panes.MapBasePane);

}).call(this);
